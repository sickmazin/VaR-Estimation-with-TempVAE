# TempVAE: Deep Stochastic Volatility for Value-at-Risk

## 1. Scientific Abstract & Objective

This project implements a **Temporal Variational Autoencoder (TempVAE)** for multivariate financial time series analysis. The core objective is to model the joint distribution of asset returns $R_t$ by inferring a latent stochastic process $Z_t$ that represents unobserved market factors (regimes).

The model optimizes the Evidence Lower Bound (ELBO), balancing reconstruction accuracy against the complexity of the latent dynamics.

---

## 2. Mathematical Framework & Architecture

Based on the reference paper, the model assumes the observed returns $R_{1:T}$ are generated by a latent process $Z_{1:T}$ through an autoregressive structure.

### 2.1. Generative Model (Decoder)
The joint probability factorizes into a **Prior** (transition dynamics) and a **Likelihood** (emission):

$$
p_\theta(R, Z) = \prod_{t=1}^T \underbrace{p_\theta(Z_t \mid Z_{1:t-1})}_{\text{Prior}} \cdot \underbrace{p_\theta(R_t \mid Z_{1:t})}_{\text{Likelihood}}
$$

1.  **Prior (Latent Dynamics):** $Z_t$ depends on the history of latent states via a specific Recurrent Neural Network ($\text{RNN}^z$).
    $$Z_t \mid Z_{1:t-1} \sim \mathcal{N}(\mu^z_t, \Sigma^z_t)$$
    *Note: As per Appendix B.2 of the paper, the Prior is **non-trainable** (fixed) to enforce stable regularization.*

2.  **Likelihood (Emission):** The return $R_t$ depends on the sequence of latent factors up to time $t$ ($Z_{1:t}$), propagated by a second RNN ($\text{RNN}^r$).
    $$R_t \mid Z_{1:t} \sim \mathcal{N}(\mu^r_t, \Sigma^r_t)$$
    *Covariance Structure:* The paper specifies a **Rank-1 perturbation** output for $\Sigma^r$ (Low-rank approximation) to model asset correlations efficiently, while $\Sigma^z$ uses a diagonal structure.

### 2.2. Inference Model (Encoder)
Since the true posterior is intractable, we approximate it with $q_\phi$, which conditions on the **entire** observation sequence $R_{1:T}$ (future and past) using a Bidirectional GRU:

$$q_\phi(Z \mid R) = \prod_{t=1}^T q_\phi(Z_t \mid Z_{1:t-1}, R_{1:T})$$

The architecture integrates global context as follows:
$$ \hat{h}^z_t = \text{RNN}_I^z (\hat{h}^z_{t-1}, Z_{t-1}, [\hat{h}^{\rightarrow}_t, \hat{h}^{\leftarrow}_t]) $$
Where $[\hat{h}^{\rightarrow}_t, \hat{h}^{\leftarrow}_t]$ are the concatenated forward and backward states of the Bi-GRU processing $R$.

---

## 3. Paper Replication: "Estimating the Value-at-Risk by Temporal VAE"

This repository replicates the methodology from **"Estimating the Value-at-Risk by Temporal VAE"** (`paper/EstimatingVaR_TempVAE.pdf`).

### Implementation Details (from Section 3 & Appendix)
*   **Latent Dim**: 10.
*   **Hidden Layers**: 16 units (RNNs and MLPs).
*   **Initialization**: He (Variance Scaling).
*   **Regularization**: L2 ($\lambda=0.01$) on MLP weights, Dropout ($10\%$) on RNNs.
*   **Activation**: ReLU for hidden layers; Exponential for diagonal covariance elements.

### Benchmarks (`final_data/ORIGINALE_2`)
The following artifacts validate the model against the paper's results:
*   **`var_series.png`**: VaR predictions under volatile regimes.
*   **`latent_manifold.png`**: Clustering of market states in the latent space.
*   **`active_units.png`**: Verification of "Active Units" via KL-Divergence to ensure no posterior collapse occurs.

---

## 4. Project Structure

### ðŸ§  Model Architecture
*   **`TempVae.py`**: **THE MODEL**. Implements the equations above:
    *   **Encoder**: Bi-GRU + Autoregressive Inference ($Z_t | Z_{<t}, \text{Context}$). 
    *   **Decoder**: Fixed Prior RNN + Rank-1 Likelihood RNN.

### âš™ï¸ Execution
*   **`main.py`**: **TRAINING**. Handles data loading (`FinancialDataset`), ELBO optimization, and saving `best_model.pth`.
*   **`inference_comparison.py`**: **INFERENCE**. Loads trained weights for backtesting without retraining.

### ðŸ”¬ Replication
*   **`paper_exact_replication.py`**: **STRICT BENCHMARK**. Hardcoded parameters to match the paper exactly.

---

## 5. Usage

### Option A: Train from Scratch
```bash
python main.py
```

### Option B: Run Inference (Pre-trained)
```bash
python inference_comparison.py
```

---

*Author: Mattia
